<!-- searchBar -->
<div class="row">

  <form [formGroup]="form">
    <div class="col-12 grid-margin">
      <div class="row g-3">

        <div class="col-md-3" *ngIf="accessToFactories">
          <ng-select [items]="FactoriesDropDown" bindLabel="name" bindValue="id" [searchable]="false"
            placeholder="Select Plant" formControlName="factoryId" (change)="getTransformersPerFatory($event.id)"
            [(ngModel)]="selectedFactory">
          </ng-select>
        </div>
        <div class="col-md-3">
          <ng-select [items]="transformers" bindLabel="transformerName" bindValue="transformerName" [searchable]="false"
            placeholder="Select Transformer" [(ngModel)]="selectedtransformer" [ngModelOptions]="{ standalone: true }">
          </ng-select>
        </div>
        <div class="col-md-6 d-flex align-items-center">
          <div class="col-md-4">
            <button style="margin-right: 1rem" [disabled]="form.invalid" class="btn btn-danger" (click)="liveData()">
              Live
            </button>
            <button (click)="customDate()" class="btn btn-secondary">
              Custom
            </button>
          </div>

          <div class="col-md-8" *ngIf="customBtnClicked">
            <div class="d-flex align-items-center gap-2">

              <input type="date" class="form-control" max="{{ lastDay }}" [ngModel]="lastDay"
                (ngModelChange)="onFromDateChange($event)" formControlName="from" />

              <span>:</span>

              <input type="date" class="form-control" [min]="lastDay" max="{{ nextDay | date : 'yyyy-MM-dd' }}"
                [ngModel]="toDate | date : 'yyyy-MM-dd'" (ngModelChange)="toDate = $event" formControlName="to" />


              <button type="button" (click)="getTransformerReads()" [disabled]="form.invalid"
                class="btn btn-search btn-icon-text">
                <i class="btn-icon-prepend" data-feather="filter" appFeatherIcon></i>
                Search
              </button>

            </div>
          </div>

        </div>
        <div class="row my-3">
          <div class="col-md-5 d-flex align-items-center" *ngIf="tranformerRead?.length != 0">
            <p class="fw-bold">
              Total Energy Consumption: {{ totalEnergyConsumption }} kWh
            </p>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="col-xl-12 stretch-card grid-margin">
  <div class="card">
    <div class="card-body table-responsive" *ngIf="!customBtnClicked && tranformerRead?.length">
      <!-- <p-table [value]="tranformerRead" [paginator]="true" [rows]="30" [totalRecords]="totalCount" [lazy]="true"
        (onLazyLoad)="loadLazy($event)" styleClass="p-datatable-striped table table-sm"> -->
      <p-table [value]="tranformerRead" styleClass="p-datatable-striped table table-sm">
        <ng-template pTemplate="caption">
          <div class="flex">
            <button type="button" pButton pRipple (click)="exportExcel()" class="mr-2 bg-success rounded-3 p-2"
              pTooltip="XLS" tooltipPosition="bottom">
              <i class="pi pi-file-excel text-white"></i>
            </button>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th>Shift Start Time</th>
            <th>Diff Energy 1</th>
            <th>Diff Energy 2</th>
            <th>Diff Energy 3</th>
            <th>Energy 1</th>
            <th>Energy 2</th>
            <th>Energy 3</th>
            <th>Fault</th>
            <th>I1</th>
            <th>I2</th>
            <th>I3</th>
            <th>pF1</th>
            <th>pF2</th>
            <th>pF3</th>
            <th>Pact1</th>
            <th>Pact2</th>
            <th>Papp1</th>
            <th>Papp2</th>
            <th>Papp3</th>
            <th>Preact1</th>
            <th>Preact2</th>
            <th>Preact3</th>
            <th>ThDi1</th>
            <th>ThDi2</th>
            <th>ThDi3</th>
            <th>ThDv1</th>
            <th>ThDv2</th>
            <th>ThDv3</th>
            <th>V1</th>
            <th>V2</th>
            <th>V3</th>
            <th>Time Stamp</th>
          </tr>

        </ng-template>

        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item?.shiftStartTime | date : "dd-MM-yyyy" }}</td>
            <td>{{ item?.diffEnergy1 }}</td>
            <td>{{ item?.diffEnergy2 }}</td>
            <td>{{ item?.diffEnergy3 }}</td>
            <td>{{ item?.energy1 }}</td>
            <td>{{ item?.energy2 }}</td>
            <td>{{ item?.energy3 }}</td>
            <td>{{ item?.fault }}</td>
            <td>{{ item?.i1 }}</td>
            <td>{{ item?.i2 }}</td>
            <td>{{ item?.i3 }}</td>
            <td>{{ item?.pF1 }}</td>
            <td>{{ item?.pF2 }}</td>
            <td>{{ item?.pF3 }}</td>
            <td>{{ item?.pact1 }}</td>
            <td>{{ item?.pact2 }}</td>
            <td>{{ item?.papp1 }}</td>
            <td>{{ item?.papp2 }}</td>
            <td>{{ item?.papp3 }}</td>
            <td>{{ item?.preact1 }}</td>
            <td>{{ item?.preact2 }}</td>
            <td>{{ item?.preact3 }}</td>
            <td>{{ item?.thDi1 }}</td>
            <td>{{ item?.thDi2 }}</td>
            <td>{{ item?.thDi3 }}</td>
            <td>{{ item?.thDv1 }}</td>
            <td>{{ item?.thDv2 }}</td>
            <td>{{ item?.thDv3 }}</td>
            <td>{{ item?.v1 }}</td>
            <td>{{ item?.v2 }}</td>
            <td>{{ item?.v3 }}</td>

            <td>{{ item?.timeStamp }}</td>
            <!-- <td>{{ item?.avgPapp2 }}</td>
            <td>{{ item?.minPapp3 }}</td>
            <td>{{ item?.maxPapp3 }}</td>
            <td>{{ item?.avgPapp3 }}</td>
            <td>{{ item?.minPact1 }}</td>
            <td>{{ item?.maxPact1 }}</td>
            <td>{{ item?.avgPact1 }}</td>
            <td>{{ item?.minPact2 }}</td>
            <td>{{ item?.maxPact2 }}</td>
            <td>{{ item?.avgPact2 }}</td>
            <td>{{ item?.minPact3 }}</td>
            <td>{{ item?.maxPact3 }}</td>
            <td>{{ item?.avgPact3 }}</td> -->
            <td>{{ item?.totalEnergyConsumption }}</td>
          </tr>
        </ng-template>
      </p-table>

    </div>
    <div class="card-body table-responsive custom-table-wrapper"
      *ngIf="customBtnClicked && isCustomSearch && tranformerReadCustom?.length">
      <div class="flex justify-content-center mb-4 gap-3">
        <p-selectButton [options]="selectOptions" [(ngModel)]="selectedName" optionLabel="name" optionValue="name"
          class="custom-select-btn m-2"></p-selectButton>

        <button type="button" pButton pRipple (click)="exportExcel()" class="mt-2 mr-2 bg-success rounded-3 p-2"
          pTooltip="XLS" tooltipPosition="bottom">
          <i class="pi pi-file-excel text-white"></i>
        </button>

      </div>
      <!-- <p-table [value]="tranformerReadCustom" [paginator]="true" [rows]="30" [totalRecords]="totalCount" [lazy]="true"
        (onLazyLoad)="loadLazy($event)" styleClass="custom-p-table"> -->
      <p-table [value]="tranformerReadCustom" styleClass="custom-p-table">
        <ng-template pTemplate="header">
          <tr>
            <th colspan="3" class="text-center header-group">Min</th>
            <th colspan="3" class="text-center header-group">Max</th>
            <th colspan="3" class="text-center header-group">Avg</th>
            <th rowspan="3" class=" text-center header-sticky">Total Energy</th>
            <th rowspan="3" class="text-center header-sticky">Day</th>
          </tr>

          <tr>
            <th *ngFor="let e of selectedItem">{{ e | uppercase }}</th>
            <th *ngFor="let e of selectedItem">{{ e | uppercase }}</th>
            <th *ngFor="let e of selectedItem">{{ e | uppercase }}</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-energy>
          <tr>
            <td *ngFor="let e of selectedItem">
              {{ energy[selectedName]?.min?.[e] }}
            </td>

            <td *ngFor="let e of selectedItem">
              {{ energy[selectedName]?.max?.[e] }}
            </td>

            <td *ngFor="let e of selectedItem">
              {{ energy[selectedName]?.avg?.[e] }}
            </td>

            <td>{{ energy.totalEnergyConsumption }}</td>
            <td>{{ energy.startDay }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>

  </div>